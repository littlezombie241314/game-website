<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸œäº¬èµ›è½¦é£è¡Œ - SkyWings</title>
    <meta name="description" content="åœ¨ä¸œäº¬éƒ½å¸‚ä¸Šç©ºä½“éªŒé©¬é‡Œå¥¥èµ›è½¦é£æ ¼çš„é£è¡Œç«é€Ÿæ¸¸æˆï¼">
    <link rel="stylesheet" href="./assets/css/styles.css">
    <style>
        /* ä¸œäº¬èµ›è½¦ä¸»é¢˜æ¸¸æˆé¡µé¢ä¸“ç”¨æ ·å¼ */
        .game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: linear-gradient(180deg, 
                #FF6B9D 0%, 
                #FF8E53 25%, 
                #FFD166 50%, 
                #06D6A0 75%, 
                #118AB2 100%);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-canvas {
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            box-shadow: 0 0 60px rgba(255, 107, 157, 0.4);
        }

        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #ffffff;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 107, 157, 0.8);
            background: rgba(255, 107, 157, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.4);
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(17, 138, 178, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: #ffffff;
            display: none;
            box-shadow: 0 0 40px rgba(255, 107, 157, 0.6);
            border: 3px solid rgba(255, 107, 157, 0.6);
        }

        .game-over h2 {
            color: #FFD166;
            margin-bottom: 20px;
            font-size: 32px;
            text-shadow: 0 0 10px rgba(255, 209, 102, 0.8);
        }

        .game-over p {
            margin-bottom: 30px;
            font-size: 18px;
            color: #FFD166;
        }

        .restart-btn {
            background: linear-gradient(135deg, #FF6B9D, #FF8E53);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.4);
        }

        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.6);
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            font-size: 14px;
            text-shadow: 0 0 5px rgba(255, 107, 157, 0.8);
            background: rgba(255, 107, 157, 0.6);
            padding: 10px 15px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        /* é“å…·æ æ ·å¼ */
        .powerup-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 107, 157, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 107, 157, 0.8);
        }

        .powerup-icon {
            font-size: 24px;
            margin-right: 8px;
        }

        /* è§¦æ‘¸æ§åˆ¶æŒ‰é’® */
        .touch-controls {
            position: absolute;
            bottom: 100px;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 107, 157, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            backdrop-filter: blur(10px);
        }

        .control-btn:active {
            background: rgba(255, 107, 157, 0.9);
            transform: scale(0.95);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-canvas {
                width: 95vw !important;
                height: 70vh !important;
            }
            
            .game-ui {
                font-size: 16px;
                top: 10px;
                left: 10px;
            }
            
            .instructions {
                font-size: 12px;
                bottom: 10px;
            }
            
            .powerup-display {
                font-size: 14px;
                top: 10px;
                right: 10px;
            }
            
            .touch-controls {
                display: flex;
            }
        }

        @media (max-width: 480px) {
            .game-canvas {
                width: 98vw !important;
                height: 60vh !important;
            }
            
            .game-over {
                padding: 20px;
                width: 90%;
            }
            
            .game-over h2 {
                font-size: 24px;
            }
            
            .game-over p {
                font-size: 16px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container nav">
            <a class="brand" href="index.html" aria-label="è¿”å›é¦–é¡µ">
                <span class="brand-badge" aria-hidden="true"></span>
                <span>SkyWings</span>
            </a>
            <nav class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="games.html">æ¸¸æˆ</a>
                <a href="destinations.html">ç›®çš„åœ°</a>
                <a href="community.html">ç¤¾åŒº</a>
            </nav>
        </div>
    </header>

    <main class="game-container">
        <div class="game-ui">
            <span>è·ç¦»: <span id="distance">0</span>m</span>
            <span style="margin-left: 20px;">é€Ÿåº¦: <span id="speed">0</span>km/h</span>
            <span style="margin-left: 20px;">é“å…·: <span id="powerup-count">0</span></span>
        </div>
        
        <div class="powerup-display">
            <span class="powerup-icon" id="current-powerup">ğŸš€</span>
            <span id="powerup-name">æ— é“å…·</span>
        </div>
        
        <canvas id="gameCanvas" class="game-canvas" width="800" height="600"></canvas>
        
        <div class="instructions">
            â†‘â†“â†â†’ æ§åˆ¶é£è¡Œæ–¹å‘ | ç©ºæ ¼é”®ä½¿ç”¨é“å…· | æ”¶é›†é“å…·è·å¾—ç‰¹æ®Šèƒ½åŠ›ï¼
        </div>
        
        <div class="touch-controls">
            <div class="control-btn" id="left-btn">â†</div>
            <div class="control-btn" id="right-btn">â†’</div>
            <div class="control-btn" id="up-btn">â†‘</div>
            <div class="control-btn" id="down-btn">â†“</div>
            <div class="control-btn" id="powerup-btn">ğŸ’¥</div>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>æ¸¸æˆç»“æŸï¼</h2>
            <p>ä½ é£è¡Œäº† <span id="final-distance">0</span> ç±³</p>
            <p>æ”¶é›†äº† <span id="final-powerups">0</span> ä¸ªé“å…·</p>
            <button class="restart-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
        </div>
    </main>

    <script>
        // æ¸¸æˆå˜é‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameRunning = true;
        let distance = 0;
        let speed = 0;
        let powerupsCollected = 0;
        let currentPowerup = null;
        
        // éŸ³æ•ˆå˜é‡
        let engineSound = null;
        let afterburnerSound = null;
        let soundEnabled = true;
        
        // ç©å®¶é£è¡Œå™¨ï¼ˆè¥¿ç“œå¤ªéƒè”åæ¬¾ï¼‰
        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            width: 50,
            height: 25,
            speedX: 0,
            speedY: 0,
            maxSpeed: 12, // ä¼˜åŒ–æœ€å¤§é€Ÿåº¦
            acceleration: 0.6, // æé«˜åŠ é€Ÿåº¦ï¼Œè®©å“åº”æ›´çµæ•
            friction: 0.85, // é™ä½æ‘©æ“¦åŠ›ï¼Œè®©æ§åˆ¶æ›´æµç•…
            afterburner: false // åŠ åŠ›ç‡ƒçƒ§å™¨çŠ¶æ€
        };
        
        // èµ›é“å’Œéšœç¢ç‰©
        const track = [];
        const obstacles = [];
        const powerups = [];
        const buildings = [];
        const clouds = [];
        
        // é“å…·ç±»å‹
        const POWERUP_TYPES = {
            SPEED_BOOST: { emoji: 'ğŸš€', name: 'é€Ÿåº¦æå‡', duration: 3000 },
            SHIELD: { emoji: 'ğŸ›¡ï¸', name: 'æŠ¤ç›¾', duration: 5000 },
            MAGNET: { emoji: 'ğŸ§²', name: 'ç£é“', duration: 4000 },
            STAR: { emoji: 'â­', name: 'æ— æ•Œæ˜Ÿ', duration: 6000 }
        };
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // åˆå§‹åŒ–éŸ³æ•ˆ
            initSounds();
            
            // åˆ›å»ºåˆå§‹èµ›é“
            createInitialTrack();
            
            // åˆ›å»ºåˆå§‹å»ºç­‘
            createInitialBuildings();
            
            // åˆ›å»ºåˆå§‹äº‘æœµ
            createInitialClouds();
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            gameLoop();
        }
        
        // åˆå§‹åŒ–éŸ³æ•ˆ
        function initSounds() {
            try {
                // åˆ›å»ºå‘åŠ¨æœºéŸ³æ•ˆï¼ˆä½¿ç”¨Web Audio APIï¼‰
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // å‘åŠ¨æœºåŸºç¡€éŸ³æ•ˆ
                engineSound = {
                    context: audioContext,
                    oscillator: null,
                    gainNode: null,
                    playing: false
                };
                
                // åŠ åŠ›ç‡ƒçƒ§å™¨éŸ³æ•ˆ
                afterburnerSound = {
                    context: audioContext,
                    oscillator: null,
                    gainNode: null,
                    playing: false
                };
                
                console.log('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.log('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­æ— å£°æ¨¡å¼:', error);
                soundEnabled = false;
            }
        }
        
        // æ’­æ”¾å‘åŠ¨æœºéŸ³æ•ˆ
        function playEngineSound(speedRatio) {
            if (!soundEnabled || !engineSound.context) return;
            
            try {
                if (!engineSound.playing) {
                    engineSound.oscillator = engineSound.context.createOscillator();
                    engineSound.gainNode = engineSound.context.createGain();
                    
                    engineSound.oscillator.connect(engineSound.gainNode);
                    engineSound.gainNode.connect(engineSound.context.destination);
                    
                    engineSound.oscillator.type = 'sawtooth';
                    engineSound.oscillator.frequency.value = 80 + speedRatio * 120; // é¢‘ç‡éšé€Ÿåº¦å˜åŒ–
                    engineSound.gainNode.gain.value = 0.1 + speedRatio * 0.1; // éŸ³é‡éšé€Ÿåº¦å˜åŒ–
                    
                    engineSound.oscillator.start();
                    engineSound.playing = true;
                } else {
                    // æ›´æ–°éŸ³æ•ˆå‚æ•°
                    engineSound.oscillator.frequency.value = 80 + speedRatio * 120;
                    engineSound.gainNode.gain.value = 0.1 + speedRatio * 0.1;
                }
            } catch (error) {
                console.log('å‘åŠ¨æœºéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // æ’­æ”¾åŠ åŠ›ç‡ƒçƒ§å™¨éŸ³æ•ˆ
        function playAfterburnerSound() {
            if (!soundEnabled || !afterburnerSound.context) return;
            
            try {
                if (!afterburnerSound.playing) {
                    afterburnerSound.oscillator = afterburnerSound.context.createOscillator();
                    afterburnerSound.gainNode = afterburnerSound.context.createGain();
                    
                    afterburnerSound.oscillator.connect(afterburnerSound.gainNode);
                    afterburnerSound.gainNode.connect(afterburnerSound.context.destination);
                    
                    afterburnerSound.oscillator.type = 'square';
                    afterburnerSound.oscillator.frequency.value = 200;
                    afterburnerSound.gainNode.gain.value = 0.15;
                    
                    afterburnerSound.oscillator.start();
                    afterburnerSound.playing = true;
                }
            } catch (error) {
                console.log('åŠ åŠ›ç‡ƒçƒ§å™¨éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // åœæ­¢åŠ åŠ›ç‡ƒçƒ§å™¨éŸ³æ•ˆ
        function stopAfterburnerSound() {
            if (!soundEnabled || !afterburnerSound.playing) return;
            
            try {
                afterburnerSound.oscillator.stop();
                afterburnerSound.playing = false;
            } catch (error) {
                console.log('åŠ åŠ›ç‡ƒçƒ§å™¨éŸ³æ•ˆåœæ­¢å¤±è´¥:', error);
            }
        }
        
        // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
        function stopAllSounds() {
            if (engineSound.playing) {
                try {
                    engineSound.oscillator.stop();
                    engineSound.playing = false;
                } catch (error) {
                    console.log('å‘åŠ¨æœºéŸ³æ•ˆåœæ­¢å¤±è´¥:', error);
                }
            }
            
            if (afterburnerSound.playing) {
                try {
                    afterburnerSound.oscillator.stop();
                    afterburnerSound.playing = false;
                } catch (error) {
                    console.log('åŠ åŠ›ç‡ƒçƒ§å™¨éŸ³æ•ˆåœæ­¢å¤±è´¥:', error);
                }
            }
        }
        
        // åˆ›å»ºåˆå§‹èµ›é“
        function createInitialTrack() {
            for (let i = 0; i < 20; i++) {
                track.push({
                    x: i * 80,
                    y: canvas.height / 2 + Math.sin(i * 0.3) * 50,
                    width: 80,
                    height: 10,
                    color: i % 2 === 0 ? '#FF6B9D' : '#FFD166'
                });
            }
        }
        
        // åˆ›å»ºåˆå§‹å»ºç­‘
        function createInitialBuildings() {
            for (let i = 0; i < 15; i++) {
                const height = Math.random() * 100 + 50;
                buildings.push({
                    x: Math.random() * canvas.width * 2,
                    y: canvas.height - height,
                    width: Math.random() * 40 + 20,
                    height: height,
                    color: `hsl(${Math.random() * 60 + 200}, 70%, 60%)`,
                    windows: []
                });
                
                // ä¸ºå»ºç­‘æ·»åŠ çª—æˆ·
                const building = buildings[buildings.length - 1];
                for (let j = 0; j < 3; j++) {
                    for (let k = 0; k < 3; k++) {
                        building.windows.push({
                            x: building.x + 5 + j * (building.width - 10) / 3,
                            y: building.y + 5 + k * (building.height - 10) / 3,
                            width: (building.width - 10) / 3 - 5,
                            height: (building.height - 10) / 3 - 5,
                            lit: Math.random() > 0.3
                        });
                    }
                }
            }
        }
        
        // åˆ›å»ºåˆå§‹äº‘æœµ
        function createInitialClouds() {
            for (let i = 0; i < 10; i++) {
                clouds.push({
                    x: Math.random() * canvas.width * 2,
                    y: Math.random() * canvas.height * 0.4,
                    width: Math.random() * 60 + 40,
                    height: Math.random() * 30 + 20,
                    speed: Math.random() * 0.5 + 0.2
                });
            }
        }
        
        // ç»˜åˆ¶ç©å®¶é£è¡Œå™¨ï¼ˆè¥¿ç“œå¤ªéƒè”åæ¬¾ï¼‰
        function drawPlayer() {
            ctx.save();
            
            // æ£€æµ‹æ˜¯å¦å¤„äºé«˜é€ŸçŠ¶æ€ï¼ˆæ¿€æ´»åŠ åŠ›ç‡ƒçƒ§å™¨ï¼‰
            const speedRatio = speed / player.maxSpeed;
            player.afterburner = speedRatio > 0.7;
            
            // è¥¿ç“œå¤ªéƒè”åæ¬¾é£è¡Œå™¨ä¸»ä½“ - å¤æ—¥è¥¿ç“œé£æ ¼
            const centerX = player.x;
            const centerY = player.y;
            
            // æœºèº«ä¸»ä½“ï¼ˆè¥¿ç“œçš®ç»¿è‰²ï¼‰
            const bodyGradient = ctx.createLinearGradient(
                centerX - player.width/2, centerY,
                centerX + player.width/2, centerY
            );
            bodyGradient.addColorStop(0, '#2E8B57'); // æ·±ç»¿è‰²
            bodyGradient.addColorStop(0.5, '#3CB371'); // ä¸­ç»¿è‰²
            bodyGradient.addColorStop(1, '#2E8B57'); // æ·±ç»¿è‰²
            
            ctx.fillStyle = bodyGradient;
            
            // æœºèº«ä¸»ä½“ï¼ˆæ¤­åœ†å½¢è¥¿ç“œå½¢çŠ¶ï¼‰
            ctx.beginPath();
            ctx.ellipse(centerX, centerY, player.width/2, player.height/2, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // è¥¿ç“œæœè‚‰éƒ¨åˆ†ï¼ˆçº¢è‰²ï¼‰
            const fleshGradient = ctx.createRadialGradient(
                centerX, centerY, 0,
                centerX, centerY, player.width/2
            );
            fleshGradient.addColorStop(0, '#FF6B6B'); // äº®çº¢è‰²
            fleshGradient.addColorStop(0.7, '#FF4757'); // æ·±çº¢è‰²
            fleshGradient.addColorStop(1, '#FF3838'); // æœ€çº¢è‰²
            
            ctx.fillStyle = fleshGradient;
            ctx.beginPath();
            ctx.ellipse(centerX, centerY, player.width/2 - 5, player.height/2 - 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // è¥¿ç“œå¤ªéƒæ ‡å¿—æ€§å¸½å­ï¼ˆç»¿è‰²å¸½å­ï¼‰
            ctx.fillStyle = '#228B22'; // æ£®æ—ç»¿
            ctx.beginPath();
            ctx.moveTo(centerX - player.width/3, centerY - player.height/2);
            ctx.lineTo(centerX + player.width/3, centerY - player.height/2);
            ctx.lineTo(centerX + player.width/4, centerY - player.height/4);
            ctx.lineTo(centerX - player.width/4, centerY - player.height/4);
            ctx.closePath();
            ctx.fill();
            
            // å¸½å­è£…é¥°ï¼ˆç™½è‰²æ¡çº¹ï¼‰
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(centerX - player.width/4, centerY - player.height/2, player.width/2, 3);
            
            // è¥¿ç“œå¤ªéƒçœ¼ç›ï¼ˆé»‘è‰²åœ†ç‚¹ï¼‰
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(centerX - player.width/8, centerY - player.height/8, player.width/12, 0, Math.PI * 2);
            ctx.arc(centerX + player.width/8, centerY - player.height/8, player.width/12, 0, Math.PI * 2);
            ctx.fill();
            
            // è¥¿ç“œå¤ªéƒç¬‘å®¹ï¼ˆå¼§å½¢ï¼‰
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, player.width/6, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();
            
            // æœºç¿¼ï¼ˆè¥¿ç“œå¶å­å½¢çŠ¶ï¼‰
            ctx.fillStyle = '#32CD32'; // é…¸æ©™ç»¿
            
            // å·¦æœºç¿¼ï¼ˆå¶å­å½¢çŠ¶ï¼‰
            ctx.beginPath();
            ctx.moveTo(centerX - player.width/2, centerY);
            ctx.quadraticCurveTo(centerX - player.width, centerY - player.height/4, centerX - player.width/2, centerY + player.height/2);
            ctx.quadraticCurveTo(centerX - player.width/3, centerY + player.height/4, centerX - player.width/2, centerY);
            ctx.closePath();
            ctx.fill();
            
            // å³æœºç¿¼ï¼ˆå¶å­å½¢çŠ¶ï¼‰
            ctx.beginPath();
            ctx.moveTo(centerX + player.width/2, centerY);
            ctx.quadraticCurveTo(centerX + player.width, centerY - player.height/4, centerX + player.width/2, centerY + player.height/2);
            ctx.quadraticCurveTo(centerX + player.width/3, centerY + player.height/4, centerX + player.width/2, centerY);
            ctx.closePath();
            ctx.fill();
            
            // å°¾ç¿¼ï¼ˆè¥¿ç“œè—¤å½¢çŠ¶ï¼‰
            ctx.fillStyle = '#8B4513'; // æ£•è‰²
            
            // å‚ç›´å°¾ç¿¼ï¼ˆè—¤è”“å½¢çŠ¶ï¼‰
            ctx.beginPath();
            ctx.moveTo(centerX, centerY + player.height/2);
            ctx.bezierCurveTo(
                centerX - player.width/6, centerY + player.height/2,
                centerX - player.width/8, centerY + player.height,
                centerX, centerY + player.height
            );
            ctx.bezierCurveTo(
                centerX + player.width/8, centerY + player.height,
                centerX + player.width/6, centerY + player.height/2,
                centerX, centerY + player.height/2
            );
            ctx.closePath();
            ctx.fill();
            
            // å‘åŠ¨æœºå–·å£å’ŒåŠ åŠ›ç‡ƒçƒ§å™¨æ•ˆæœï¼ˆè¥¿ç“œå¤ªéƒé£æ ¼ï¼‰
            if (player.afterburner) {
                // åŠ åŠ›ç‡ƒçƒ§å™¨ç«ç„°æ•ˆæœï¼ˆè¥¿ç“œç±½å–·å°„ï¼‰
                for (let i = 0; i < 5; i++) {
                    const seedX = centerX + (Math.random() - 0.5) * player.width/3;
                    const seedY = centerY + player.height/2 + Math.random() * player.height;
                    
                    ctx.fillStyle = '#000000'; // é»‘è‰²è¥¿ç“œç±½
                    ctx.beginPath();
                    ctx.ellipse(seedX, seedY, 2, 4, Math.PI/4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // ç«ç„°æ•ˆæœï¼ˆçº¢è‰²å…‰èŠ’ï¼‰
                const flameGradient = ctx.createLinearGradient(
                    centerX, centerY + player.height/2,
                    centerX, centerY + player.height * 1.5
                );
                flameGradient.addColorStop(0, '#FF6B6B'); // çº¢è‰²
                flameGradient.addColorStop(0.5, '#FF4757'); // æ·±çº¢è‰²
                flameGradient.addColorStop(1, 'rgba(255, 71, 87, 0)'); // é€æ˜
                
                ctx.fillStyle = flameGradient;
                ctx.globalAlpha = 0.7;
                ctx.beginPath();
                ctx.moveTo(centerX - player.width/6, centerY + player.height/2);
                ctx.lineTo(centerX - player.width/4, centerY + player.height * 1.5);
                ctx.lineTo(centerX + player.width/4, centerY + player.height * 1.5);
                ctx.lineTo(centerX + player.width/6, centerY + player.height/2);
                ctx.closePath();
                ctx.fill();
                ctx.globalAlpha = 1.0;
            } else {
                // æ™®é€šå‘åŠ¨æœºå–·å£ï¼ˆè¥¿ç“œå›¾æ¡ˆï¼‰
                ctx.fillStyle = '#2E8B57';
                ctx.beginPath();
                ctx.arc(centerX, centerY + player.height/2, player.width/6, 0, Math.PI * 2);
                ctx.fill();
                
                // è¥¿ç“œç±½è£…é¥°
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.ellipse(centerX - 3, centerY + player.height/2, 1, 2, Math.PI/4, 0, Math.PI * 2);
                ctx.ellipse(centerX + 3, centerY + player.height/2, 1, 2, -Math.PI/4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // è¥¿ç“œå¤ªéƒè”åæ ‡å¿—ï¼ˆæœºèº«ä¸Šéƒ¨è¥¿ç“œç±½å›¾æ¡ˆï¼‰
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(centerX - 5, centerY - player.height/4, 1, 2, Math.PI/4, 0, Math.PI * 2);
            ctx.ellipse(centerX + 5, centerY - player.height/4, 1, 2, -Math.PI/4, 0, Math.PI * 2);
            ctx.fill();
            
            // å¦‚æœæœ‰é“å…·æ•ˆæœï¼Œæ˜¾ç¤ºç‰¹æ•ˆï¼ˆè¥¿ç“œå¤ªéƒé£æ ¼ï¼‰
            if (currentPowerup) {
                ctx.strokeStyle = POWERUP_TYPES[currentPowerup.type].emoji === 'â­' ? '#FFD166' : 
                                POWERUP_TYPES[currentPowerup.type].emoji === 'ğŸ›¡ï¸' ? '#06D6A0' : '#FF6B6B';
                ctx.lineWidth = 3;
                ctx.setLineDash([3, 5]); // è™šçº¿æ•ˆæœ
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.width/2 + 10, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // é£è¡Œè½¨è¿¹æ•ˆæœï¼ˆè¥¿ç“œå¤ªéƒé£æ ¼ - è¥¿ç“œç±½è½¨è¿¹ï¼‰
            if (speedRatio > 0.5) {
                for (let i = 0; i < 4; i++) {
                    const seedY = centerY + player.height + i * 15;
                    const seedX = centerX + Math.sin(Date.now() * 0.01 + i) * 10;
                    
                    ctx.fillStyle = '#000000';
                    ctx.globalAlpha = 0.8 - i * 0.2;
                    ctx.beginPath();
                    ctx.ellipse(seedX, seedY, 1, 2, Math.PI/4, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
            }
            
            // è¥¿ç“œå¤ªéƒè¡¨æƒ…åŠ¨ç”»ï¼ˆæ ¹æ®é€Ÿåº¦å˜åŒ–ï¼‰
            if (speedRatio > 0.8) {
                // é«˜é€Ÿæ—¶æ˜¾ç¤ºå…´å¥‹è¡¨æƒ…ï¼ˆçœ¼ç›å˜å¤§ï¼‰
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(centerX - player.width/8, centerY - player.height/8, player.width/10, 0, Math.PI * 2);
                ctx.arc(centerX + player.width/8, centerY - player.height/8, player.width/10, 0, Math.PI * 2);
                ctx.fill();
            } else if (speedRatio < 0.3) {
                // ä½é€Ÿæ—¶æ˜¾ç¤ºå›°å€¦è¡¨æƒ…ï¼ˆçœ¯çœ¼ï¼‰
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX - player.width/8 - 2, centerY - player.height/8);
                ctx.lineTo(centerX - player.width/8 + 2, centerY - player.height/8);
                ctx.moveTo(centerX + player.width/8 - 2, centerY - player.height/8);
                ctx.lineTo(centerX + player.width/8 + 2, centerY - player.height/8);
                ctx.stroke();
            }
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶èµ›é“
        function drawTrack() {
            track.forEach(segment => {
                ctx.fillStyle = segment.color;
                ctx.fillRect(segment.x - distance % 80, segment.y, segment.width, segment.height);
                
                // èµ›é“è¾¹ç¼˜çº¿
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(segment.x - distance % 80, segment.y);
                ctx.lineTo(segment.x + segment.width - distance % 80, segment.y);
                ctx.stroke();
            });
        }
        
        // ç»˜åˆ¶å»ºç­‘
        function drawBuildings() {
            buildings.forEach(building => {
                const screenX = building.x - distance % (canvas.width * 2);
                if (screenX > -building.width && screenX < canvas.width) {
                    // å»ºç­‘ä¸»ä½“
                    ctx.fillStyle = building.color;
                    ctx.fillRect(screenX, building.y, building.width, building.height);
                    
                    // çª—æˆ·
                    building.windows.forEach(window => {
                        ctx.fillStyle = window.lit ? '#FFD166' : '#333';
                        ctx.fillRect(screenX + window.x - building.x, building.y + window.y - building.y, 
                                   window.width, window.height);
                    });
                    
                    // å»ºç­‘è½®å»“
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(screenX, building.y, building.width, building.height);
                }
            });
        }
        
        // ç»˜åˆ¶äº‘æœµ
        function drawClouds() {
            clouds.forEach(cloud => {
                const screenX = cloud.x - distance % (canvas.width * 2);
                if (screenX > -cloud.width && screenX < canvas.width) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.beginPath();
                    ctx.arc(screenX, cloud.y, cloud.width/3, 0, Math.PI * 2);
                    ctx.arc(screenX + cloud.width/3, cloud.y - cloud.height/4, cloud.width/4, 0, Math.PI * 2);
                    ctx.arc(screenX - cloud.width/3, cloud.y - cloud.height/4, cloud.width/4, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }
        
        // ç»˜åˆ¶é“å…·
        function drawPowerups() {
            powerups.forEach(powerup => {
                const screenX = powerup.x - distance % (canvas.width * 2);
                if (screenX > -20 && screenX < canvas.width) {
                    // é“å…·æ—‹è½¬åŠ¨ç”»
                    ctx.save();
                    ctx.translate(screenX, powerup.y);
                    ctx.rotate(Date.now() * 0.002);
                    
                    // é“å…·å›¾æ ‡
                    ctx.font = '24px Arial';
                    ctx.fillStyle = '#FFFFFF';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(POWERUP_TYPES[powerup.type].emoji, 0, 0);
                    
                    // é“å…·å…‰æ™•
                    ctx.strokeStyle = '#FFD166';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, 15, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.restore();
                }
            });
        }
        
        // ç»˜åˆ¶éšœç¢ç‰©
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                const screenX = obstacle.x - distance % (canvas.width * 2);
                if (screenX > -obstacle.width && screenX < canvas.width) {
                    // éšœç¢ç‰©ä¸»ä½“
                    ctx.fillStyle = obstacle.color;
                    ctx.fillRect(screenX, obstacle.y, obstacle.width, obstacle.height);
                    
                    // éšœç¢ç‰©ç»†èŠ‚
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(screenX, obstacle.y, obstacle.width, obstacle.height);
                }
            });
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function update() {
            if (!gameRunning) return;
            
            // æ›´æ–°è·ç¦»å’Œé€Ÿåº¦
            distance += speed / 10;
            speed = Math.max(2, Math.min(player.maxSpeed, speed + 0.01));
            
            // æ›´æ–°ç©å®¶ä½ç½® - æ”¹ä¸ºå‚ç›´é£è¡Œæ–¹å‘
            player.y += player.speedY;
            player.x += player.speedX;
            
            // è¾¹ç•Œæ£€æŸ¥ - è°ƒæ•´è¾¹ç•Œé€»è¾‘ä»¥é€‚åº”å‚ç›´é£è¡Œ
            player.y = Math.max(player.height/2, Math.min(canvas.height - player.height/2, player.y));
            player.x = Math.max(player.width/2, Math.min(canvas.width - player.width/2, player.x));
            
            // æ‘©æ“¦åŠ›
            player.speedY *= player.friction;
            player.speedX *= player.friction;
            
            // æ›´æ–°äº‘æœµä½ç½®
            clouds.forEach(cloud => {
                cloud.x -= cloud.speed;
                if (cloud.x < -cloud.width) {
                    cloud.x = canvas.width * 2;
                }
            });
            
            // ç”Ÿæˆæ–°èµ›é“æ®µ
            if (distance % 80 < 5) {
                const lastSegment = track[track.length - 1];
                track.push({
                    x: lastSegment.x + lastSegment.width,
                    y: canvas.height / 2 + Math.sin(track.length * 0.3) * 50,
                    width: 80,
                    height: 10,
                    color: track.length % 2 === 0 ? '#FF6B9D' : '#FFD166'
                });
            }
            
            // ç”Ÿæˆé“å…·ï¼ˆæ¯200è·ç¦»ç”Ÿæˆä¸€ä¸ªï¼‰
            if (Math.random() < 0.02 && distance % 200 < 5) {
                const powerupTypes = Object.keys(POWERUP_TYPES);
                const randomType = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
                
                powerups.push({
                    x: distance + canvas.width + Math.random() * 200,
                    y: Math.random() * canvas.height * 0.6 + canvas.height * 0.2,
                    type: randomType,
                    width: 30,
                    height: 30
                });
            }
            
            // ç”Ÿæˆéšœç¢ç‰©ï¼ˆæ¯100è·ç¦»ç”Ÿæˆä¸€ä¸ªï¼‰
            if (Math.random() < 0.03 && distance % 100 < 5) {
                obstacles.push({
                    x: distance + canvas.width + Math.random() * 100,
                    y: Math.random() * canvas.height * 0.6 + canvas.height * 0.2,
                    width: Math.random() * 30 + 20,
                    height: Math.random() * 30 + 20,
                    color: `hsl(${Math.random() * 60}, 70%, 40%)`
                });
            }
            
            // æ£€æµ‹é“å…·ç¢°æ’
            powerups.forEach((powerup, index) => {
                const screenX = powerup.x - distance % (canvas.width * 2);
                if (screenX > -20 && screenX < canvas.width) {
                    if (Math.abs(player.x - screenX) < 25 && Math.abs(player.y - powerup.y) < 25) {
                        // æ”¶é›†é“å…·
                        currentPowerup = {
                            type: powerup.type,
                            collectedAt: Date.now()
                        };
                        powerupsCollected++;
                        powerups.splice(index, 1);
                        
                        // åº”ç”¨é“å…·æ•ˆæœ
                        applyPowerupEffect(currentPowerup.type);
                    }
                }
            });
            
            // æ£€æµ‹éšœç¢ç‰©ç¢°æ’
            if (!currentPowerup || (currentPowerup.type !== 'SHIELD' && currentPowerup.type !== 'STAR')) {
                obstacles.forEach((obstacle, index) => {
                    const screenX = obstacle.x - distance % (canvas.width * 2);
                    if (screenX > -obstacle.width && screenX < canvas.width) {
                        if (Math.abs(player.x - (screenX + obstacle.width/2)) < (player.width/2 + obstacle.width/2) &&
                            Math.abs(player.y - (obstacle.y + obstacle.height/2)) < (player.height/2 + obstacle.height/2)) {
                            // ç¢°æ’éšœç¢ç‰©
                            gameOver();
                        }
                    }
                });
            }
            
            // æ£€æŸ¥é“å…·æŒç»­æ—¶é—´
            if (currentPowerup && Date.now() - currentPowerup.collectedAt > POWERUP_TYPES[currentPowerup.type].duration) {
                currentPowerup = null;
            }
            
            // æ¸…ç†å±å¹•å¤–çš„å¯¹è±¡
            cleanupObjects();
            
            // æ›´æ–°UI
            updateUI();
        }
        
        // åº”ç”¨é“å…·æ•ˆæœ
        function applyPowerupEffect(type) {
            switch (type) {
                case 'SPEED_BOOST':
                    player.maxSpeed = 12;
                    setTimeout(() => { player.maxSpeed = 8; }, POWERUP_TYPES.SPEED_BOOST.duration);
                    break;
                case 'SHIELD':
                    // æŠ¤ç›¾æ•ˆæœåœ¨ç¢°æ’æ£€æµ‹ä¸­å¤„ç†
                    break;
                case 'MAGNET':
                    // ç£é“æ•ˆæœè‡ªåŠ¨å¸å¼•é“å…·
                    break;
                case 'STAR':
                    // æ— æ•Œæ˜Ÿæ•ˆæœåœ¨ç¢°æ’æ£€æµ‹ä¸­å¤„ç†
                    break;
            }
        }
        
        // æ¸…ç†å±å¹•å¤–çš„å¯¹è±¡
        function cleanupObjects() {
            // æ¸…ç†é“å…·
            powerups.forEach((powerup, index) => {
                if (powerup.x < distance - canvas.width) {
                    powerups.splice(index, 1);
                }
            });
            
            // æ¸…ç†éšœç¢ç‰©
            obstacles.forEach((obstacle, index) => {
                if (obstacle.x < distance - canvas.width) {
                    obstacles.splice(index, 1);
                }
            });
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        function updateUI() {
            document.getElementById('distance').textContent = Math.floor(distance);
            document.getElementById('speed').textContent = Math.floor(speed * 20);
            document.getElementById('powerup-count').textContent = powerupsCollected;
            
            if (currentPowerup) {
                document.getElementById('current-powerup').textContent = POWERUP_TYPES[currentPowerup.type].emoji;
                document.getElementById('powerup-name').textContent = POWERUP_TYPES[currentPowerup.type].name;
            } else {
                document.getElementById('current-powerup').textContent = 'ğŸš€';
                document.getElementById('powerup-name').textContent = 'æ— é“å…·';
            }
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            document.getElementById('final-distance').textContent = Math.floor(distance);
            document.getElementById('final-powerups').textContent = powerupsCollected;
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            gameRunning = true;
            distance = 0;
            speed = 0;
            powerupsCollected = 0;
            currentPowerup = null;
            
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.speedX = 0;
            player.speedY = 0;
            
            track.length = 0;
            obstacles.length = 0;
            powerups.length = 0;
            buildings.length = 0;
            clouds.length = 0;
            
            createInitialTrack();
            createInitialBuildings();
            createInitialClouds();
            document.getElementById('gameOver').style.display = 'none';
            
            // é‡æ–°å¯åŠ¨æ¸¸æˆå¾ªç¯
            gameLoop();
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameRunning) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            drawBackground();
            
            // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
            drawTrack();
            drawBuildings();
            drawClouds();
            drawPowerups();
            drawObstacles();
            drawPlayer();
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            update();
            
            // ç®¡ç†éŸ³æ•ˆ
            manageSounds();
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            requestAnimationFrame(gameLoop);
        }
        
        // ç®¡ç†éŸ³æ•ˆ
        function manageSounds() {
            if (!gameRunning) {
                stopAllSounds();
                return;
            }
            
            const speedRatio = speed / player.maxSpeed;
            
            // æ’­æ”¾å‘åŠ¨æœºéŸ³æ•ˆ
            playEngineSound(speedRatio);
            
            // ç®¡ç†åŠ åŠ›ç‡ƒçƒ§å™¨éŸ³æ•ˆ
            if (player.afterburner) {
                playAfterburnerSound();
            } else {
                stopAfterburnerSound();
            }
        }
        
        // ç»˜åˆ¶èƒŒæ™¯
        function drawBackground() {
            // æ¸å˜èƒŒæ™¯å·²ç»åœ¨CSSä¸­è®¾ç½®ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ ä¸€äº›åŠ¨æ€æ•ˆæœ
            // ä¾‹å¦‚ï¼šç§»åŠ¨çš„æ˜Ÿæ˜Ÿæˆ–å…‰ç‚¹
            for (let i = 0; i < 20; i++) {
                const starX = (distance * 0.1 + i * 50) % canvas.width;
                const starY = (i * 30) % canvas.height;
                const size = Math.sin(Date.now() * 0.001 + i) * 2 + 2;
                
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.sin(Date.now() * 0.002 + i) * 0.5 + 0.5})`;
                ctx.beginPath();
                ctx.arc(starX, starY, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // é”®ç›˜æ§åˆ¶ - æ”¹ä¸ºå‚ç›´é£è¡Œæ–¹å‘
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            switch (e.key) {
                case 'ArrowUp':
                    player.speedY = -player.acceleration * 2.0; // å‘ä¸Šé£è¡Œ
                    break;
                case 'ArrowDown':
                    player.speedY = player.acceleration * 2.0; // å‘ä¸‹é£è¡Œ
                    break;
                case 'ArrowLeft':
                    player.speedX = -player.acceleration * 0.8; // å‘å·¦å¾®è°ƒ
                    break;
                case 'ArrowRight':
                    player.speedX = player.acceleration * 0.8; // å‘å³å¾®è°ƒ
                    break;
                case ' ':
                    // ä½¿ç”¨é“å…·ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (currentPowerup) {
                        // è¿™é‡Œå¯ä»¥æ·»åŠ é“å…·ä½¿ç”¨æ•ˆæœ
                    }
                    break;
            }
        });
        
        // æ·»åŠ é”®ç›˜é‡Šæ”¾äº‹ä»¶å¤„ç† - è§£å†³æ§åˆ¶ä¸æµç•…é—®é¢˜
        document.addEventListener('keyup', (e) => {
            if (!gameRunning) return;
            
            switch (e.key) {
                case 'ArrowUp':
                case 'ArrowDown':
                    player.speedY *= 0.3; // é‡Šæ”¾æ—¶å¿«é€Ÿå‡é€Ÿ
                    break;
                case 'ArrowLeft':
                case 'ArrowRight':
                    player.speedX *= 0.3; // é‡Šæ”¾æ—¶å¿«é€Ÿå‡é€Ÿ
                    break;
            }
        });
        
        // è§¦æ‘¸æ§åˆ¶ - æ”¹ä¸ºå‚ç›´é£è¡Œæ–¹å‘
        document.getElementById('up-btn').addEventListener('touchstart', () => {
            player.speedY = -player.acceleration * 1.5; // å‘ä¸Šé£è¡Œ
        });
        document.getElementById('down-btn').addEventListener('touchstart', () => {
            player.speedY = player.acceleration * 1.5; // å‘ä¸‹é£è¡Œ
        });
        document.getElementById('left-btn').addEventListener('touchstart', () => {
            player.speedX = -player.acceleration * 0.5; // å‘å·¦å¾®è°ƒ
        });
        document.getElementById('right-btn').addEventListener('touchstart', () => {
            player.speedX = player.acceleration * 0.5; // å‘å³å¾®è°ƒ
        });
        document.getElementById('powerup-btn').addEventListener('touchstart', () => {
            if (currentPowerup) {
                // ä½¿ç”¨é“å…·
            }
        });
        
        // è§¦æ‘¸ç»“æŸäº‹ä»¶
        ['up-btn', 'down-btn', 'left-btn', 'right-btn'].forEach(id => {
            document.getElementById(id).addEventListener('touchend', () => {
                player.speedX *= 0.5;
                player.speedY *= 0.5;
            });
        });
        
        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´ç”»å¸ƒå¤§å°
        window.addEventListener('resize', () => {
            canvas.width = Math.min(800, window.innerWidth - 40);
            canvas.height = Math.min(600, window.innerHeight - 200);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æ¸¸æˆ
        window.addEventListener('load', () => {
            // è°ƒæ•´ç”»å¸ƒå¤§å°
            canvas.width = Math.min(800, window.innerWidth - 40);
            canvas.height = Math.min(600, window.innerHeight - 200);
            
            // å¼€å§‹æ¸¸æˆ
            initGame();
        });
    </script>
</body>
</html>